{{- $page := .Page -}}
{{- $imagePath := .Image -}}
{{- $alt := .Alt | default "" -}}
{{- $class := .Class -}}

{{- $image := partial "helper/image" (dict "Image" $imagePath "Resources" $page.Resources) -}}
{{- if $image -}}
  {{- $resource := $image.Resource -}}
  {{- if and $resource (ne $resource.MediaType.SubType "svg") -}}
    {{- $mobileW := 640 -}}
    {{- $tabletW := 768 -}}
    {{- $desktopW := 1024 -}}

    {{- if lt $resource.Width $mobileW }}{{ $mobileW = $resource.Width }}{{ end -}}
    {{- if lt $resource.Width $tabletW }}{{ $tabletW = $resource.Width }}{{ end -}}
    {{- if lt $resource.Width $desktopW }}{{ $desktopW = $resource.Width }}{{ end -}}

    {{- with $page.Site.Params.image.widths -}}
      {{- if and (reflect.IsSlice .) (ge (len .) 3) -}}
        {{- $mobileW = index . 0 -}}
        {{- $tabletW = index . 1 -}}
        {{- $desktopW = index . 2 -}}
        {{- if lt $resource.Width $mobileW }}{{ $mobileW = $resource.Width }}{{ end -}}
        {{- if lt $resource.Width $tabletW }}{{ $tabletW = $resource.Width }}{{ end -}}
        {{- if lt $resource.Width $desktopW }}{{ $desktopW = $resource.Width }}{{ end -}}
      {{- end -}}
    {{- end -}}

    {{- $mobileImg := $resource.Resize (printf "%dx" $mobileW) -}}
    {{- $tabletImg := $resource.Resize (printf "%dx" $tabletW) -}}
    {{- $desktopImg := $resource.Resize (printf "%dx" $desktopW) -}}

    {{- $mobileWebp := $resource.Resize (printf "%dx webp" $mobileW) -}}
    {{- $tabletWebp := $resource.Resize (printf "%dx webp" $tabletW) -}}
    {{- $desktopWebp := $resource.Resize (printf "%dx webp" $desktopW) -}}

    {{- $origType := printf "image/%s" $resource.MediaType.SubType -}}
    {{- if in (slice "jpg" "jpeg") $resource.MediaType.SubType -}}
      {{- $origType = "image/jpeg" -}}
    {{- end -}}

    <picture>
      <source media="(max-width: 640px)" type="image/webp" srcset="{{ $mobileWebp.RelPermalink }}">
      <source media="(max-width: 640px)" type="{{ $origType }}" srcset="{{ $mobileImg.RelPermalink }}">

      <source media="(max-width: 1024px)" type="image/webp" srcset="{{ $tabletWebp.RelPermalink }}">
      <source media="(max-width: 1024px)" type="{{ $origType }}" srcset="{{ $tabletImg.RelPermalink }}">

      <source media="(min-width: 1025px)" type="image/webp" srcset="{{ $desktopWebp.RelPermalink }}">
      <source media="(min-width: 1025px)" type="{{ $origType }}" srcset="{{ $desktopImg.RelPermalink }}">

      <img
        src="{{ $desktopImg.RelPermalink }}"
        width="{{ $desktopImg.Width }}"
        height="{{ $desktopImg.Height }}"
        loading="lazy"
        decoding="async"
        {{ with $class }}class="{{ . }}"{{ end }}
        alt="{{ $alt }}"
      >
    </picture>
  {{- else -}}
    <img
      src="{{ $image.Permalink }}"
      {{ with $image.Width }}width="{{ . }}"{{ end }}
      {{ with $image.Height }}height="{{ . }}"{{ end }}
      loading="lazy"
      decoding="async"
      {{ with $class }}class="{{ . }}"{{ end }}
      alt="{{ $alt }}"
    >
  {{- end -}}
{{- end -}}
